<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAK SYSTEM | Terminal Institutionnel Elite v5.2</title>
    
    <!-- SÉCURITÉ & SEO -->
    <meta name="author" content="KAK_SYSTEM">
    <meta name="description" content="Terminal de trading haute performance par KAK_SYSTEM Togo.">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://images.unsplash.com https://i.ytimg.com;">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00f2ff;
            --bg-dark: #020617;
            --font-main: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(rgba(2, 6, 23, 0.75), rgba(2, 6, 23, 0.85)), 
                        url('https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: #f8fafc;
            min-height: 100vh;
        }

        .font-black { font-weight: 900; }
        .font-bold { font-weight: 700; }

        .logo-box { 
            animation: logo-spin 20s linear infinite; 
            cursor: pointer;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .logo-box:hover { filter: drop-shadow(0 0 15px var(--primary)); transform: scale(1.1); }
        @keyframes logo-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .bento-card {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        .input-pro {
            background: rgba(2, 6, 23, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            padding: 10px;
            font-family: Monaco, monospace;
            font-weight: 700;
            color: white;
            font-size: 0.8rem;
        }
        .input-pro:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(0, 242, 255, 0.15); }

        .tab-btn.active { 
            color: var(--primary); 
            background: rgba(0, 242, 255, 0.08); 
            border-bottom: 3px solid var(--primary);
        }

        .modal-kak {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
            padding: 20px;
            overflow-y: auto;
        }
        .modal-kak.active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- HEADER INSTITUTIONNEL -->
    <header class="max-w-[1600px] mx-auto flex justify-between items-center mb-6 p-5 bento-card">
        <div class="flex items-center gap-6">
            <div class="relative w-14 h-14 flex items-center justify-center logo-box" onclick="toggleModal('infoModal')">
                <div class="absolute inset-0">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 5L95 27.5V72.5L50 95L5 72.5V27.5L50 5Z" fill="none" stroke="#00f2ff" stroke-width="3" stroke-dasharray="4 4"/>
                        <circle cx="50" cy="50" r="15" stroke="#00f2ff" stroke-width="3"/>
                    </svg>
                </div>
                <span class="z-10 text-[8px] font-black text-white">KAK</span>
            </div>
            <div>
                <h1 class="text-xl font-black tracking-tighter uppercase leading-none">Terminal <span class="text-[#00f2ff]">v5.2</span></h1>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.4em] mt-1">2026 / KAK_SYSTEM TOGO</p>
            </div>
        </div>

        <nav class="hidden xl:flex items-center gap-1">
            <button onclick="switchTab('terminal')" id="btn-terminal" class="tab-btn active px-5 py-3 text-[9px] font-black transition">TABLEAU DE BORD</button>
            <button onclick="switchTab('journal')" id="btn-journal" class="tab-btn px-5 py-3 text-[9px] font-black transition">REGISTRE MAITRE</button>
            <button onclick="switchTab('profile')" id="btn-profile" class="tab-btn px-5 py-3 text-[9px] font-black transition">CONFIG PROFIL</button>
            <button onclick="switchTab('legal')" id="btn-legal" class="tab-btn px-5 py-3 text-[9px] font-black transition">SÉCURITÉ</button>
        </nav>

        <div class="text-right">
            <p id="clock" class="text-xs font-black text-slate-200">00:00:00 UTC</p>
            <p class="text-[8px] font-black text-cyan-500 tracking-widest mt-1 uppercase underline decoration-indigo-500">SYSTEM_ACTIVE</p>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto">
        
        <section id="terminal-section" class="tab-content grid grid-cols-12 gap-6">
            
            <!-- FORMULAIRE COMPLET (GAUCHE) -->
            <div class="col-span-12 lg:col-span-4 bento-card p-8 border-l-4 border-l-cyan-500">
                <h2 class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-8 flex items-center gap-3">
                    <i class="fas fa-plus-circle text-cyan-500"></i> Nouvelle Archive Stratégique
                </h2>
                <form id="tradeForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Instrument</label>
                            <input type="text" id="asset" class="input-pro w-full uppercase" placeholder="NAS100" required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Type d'Ordre</label>
                            <select id="side" class="input-pro w-full">
                                <optgroup label="Exécution Marché" class="bg-slate-900">
                                    <option value="BUY MARKET">BUY MARKET</option>
                                    <option value="SELL MARKET">SELL MARKET</option>
                                </optgroup>
                                <optgroup label="Ordres Limit" class="bg-slate-900">
                                    <option value="BUY LIMIT">BUY LIMIT</option>
                                    <option value="SELL LIMIT">SELL LIMIT</option>
                                </optgroup>
                                <optgroup label="Ordres Stop" class="bg-slate-900">
                                    <option value="BUY STOP">BUY STOP</option>
                                    <option value="SELL STOP">SELL STOP</option>
                                </optgroup>
                                <optgroup label="Ordres Avancés" class="bg-slate-900">
                                    <option value="BUY STOP LIMIT">BUY STOP LIMIT</option>
                                    <option value="SELL STOP LIMIT">SELL STOP LIMIT</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Session</label>
                            <select id="session" class="input-pro w-full">
                                <option value="LONDRES">LONDRES</option>
                                <option value="NEW YORK">NEW YORK</option>
                                <option value="ASIE">ASIE</option>
                                <option value="OVERNIGHT">OVERNIGHT</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Stratégie</label>
                            <input type="text" id="strategy" class="input-pro w-full" placeholder="SMC / ICT">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Stop (Pips)</label>
                            <input type="text" id="sl" class="input-pro w-full" oninput="forceNum(this)" placeholder="20">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Target (Pips)</label>
                            <input type="text" id="tp" class="input-pro w-full" oninput="forceNum(this)" placeholder="60">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase">Frais ($)</label>
                            <input type="text" id="comm" class="input-pro w-full" oninput="forceNum(this)" placeholder="0.00">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] font-black text-cyan-500 uppercase">Résultat Brut ($)</label>
                        <input type="text" id="pnl" class="input-pro w-full text-xl font-black text-cyan-400" oninput="forcePnL(this)" placeholder="0.00" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] font-black text-slate-500 uppercase">Notes Techniques</label>
                        <textarea id="reason" class="input-pro w-full h-20 resize-none text-[10px]" placeholder="Confluences..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-cyan-500 hover:bg-white text-black py-4 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all">
                        Valider l'Archivage KAK_SYSTEM
                    </button>
                </form>
            </div>

            <!-- ANALYTICS CENTRAUX -->
            <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                <div class="bento-card p-8 flex-1 relative overflow-hidden bg-gradient-to-br from-indigo-500/5 to-transparent">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-[0.4em] mb-4">Solde Net (Equity)</p>
                    <h3 id="display-capital" class="text-5xl font-black italic tracking-tighter text-white leading-none">$0,00</h3>
                    
                    <div class="mt-8 grid grid-cols-2 gap-4">
                        <div class="p-4 bg-white/5 rounded-xl">
                            <p class="text-[8px] font-black text-slate-500 uppercase">Profit Factor</p>
                            <p id="stat-pf" class="text-xl font-black text-indigo-400">0.00</p>
                        </div>
                        <div class="p-4 bg-white/5 rounded-xl">
                            <p class="text-[8px] font-black text-slate-500 uppercase">Winrate</p>
                            <p id="stat-wr" class="text-xl font-black text-cyan-400">0%</p>
                        </div>
                    </div>
                    <div class="mt-8 w-full bg-white/5 h-2 rounded-full overflow-hidden">
                        <div id="winrate-bar" class="h-full bg-cyan-400 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bento-card p-6 grid grid-cols-3 gap-4 items-center">
                    <div class="text-center">
                        <p class="text-[8px] font-black text-slate-500 uppercase mb-2">Dernier</p>
                        <p id="comp-last" class="text-lg font-black">--</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="comp-trend-icon" class="text-2xl mb-1 text-slate-800"><i class="fas fa-chart-line"></i></div>
                        <p id="comp-percent" class="text-[8px] font-black text-slate-500">0.00%</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[8px] font-black text-slate-500 uppercase mb-2">Précédent</p>
                        <p id="comp-prev" class="text-lg font-black">--</p>
                    </div>
                </div>
            </div>

            <!-- RISK & STATS AVANCÉES -->
            <div class="col-span-12 lg:col-span-4 bento-card p-8">
                <div class="mb-6 p-4 bg-white/5 rounded-2xl border border-white/10">
                    <p class="text-[8px] font-black text-slate-500 uppercase mb-2 tracking-widest">Opérateur</p>
                    <div class="flex justify-between items-end">
                        <h4 id="side-profile-name" class="text-xl font-black text-white leading-none uppercase tracking-tighter">---</h4>
                        <p id="side-profile-capital" class="text-[11px] font-black text-cyan-400 mono tracking-tighter">-- $</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[8px] font-black text-slate-600 uppercase mb-2">Risque $</p>
                            <input type="text" id="calc-risk" oninput="forceNum(this)" placeholder="100" class="input-pro w-full">
                        </div>
                        <div>
                            <p class="text-[8px] font-black text-slate-600 uppercase mb-2">SL (Pips)</p>
                            <input type="text" id="calc-sl-tool" oninput="forceNum(this)" placeholder="20" class="input-pro w-full">
                        </div>
                    </div>
                    <div class="p-4 bg-cyan-500/5 border border-cyan-500/20 rounded-xl text-center">
                        <p class="text-[8px] font-black text-slate-500 uppercase mb-1">Lot Recommandé</p>
                        <p id="calc-result" class="text-4xl font-black text-cyan-400 tracking-tighter">0.00</p>
                    </div>
                    
                    <div class="pt-6 border-t border-white/5 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-[8px] font-black text-slate-500 uppercase">Ratio RR Moyen</span>
                            <span id="stat-avg-rr" class="text-[10px] font-black text-indigo-400">1:0.0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[8px] font-black text-slate-500 uppercase">Gain Moyen</span>
                            <span id="stat-avg-win" class="text-[10px] font-black text-emerald-400">0.00$</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[8px] font-black text-slate-500 uppercase">Perte Moyenne</span>
                            <span id="stat-avg-loss" class="text-[10px] font-black text-rose-500">0.00$</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION REGISTRE -->
        <section id="journal-section" class="tab-content hidden">
            <div class="bento-card overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center bg-black/40">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em]">Master Ledger (Audit Log)</h3>
                    <div class="flex gap-3">
                        <button onclick="exportCSV()" class="bg-cyan-500 text-black px-5 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition">Export CSV</button>
                        <button onclick="resetSystem()" class="bg-rose-900/30 text-rose-500 px-5 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition">Purge</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-[8px] font-black text-slate-500 uppercase tracking-widest bg-black/20">
                            <tr>
                                <th class="p-5">Date</th>
                                <th class="p-5">Instrument</th>
                                <th class="p-5">Ordre</th>
                                <th class="p-5">Session</th>
                                <th class="p-5">RR</th>
                                <th class="p-5 text-center">Net PnL ($)</th>
                                <th class="p-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trade-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION PROFIL -->
        <section id="profile-section" class="tab-content hidden max-w-2xl mx-auto">
            <div class="bento-card p-10">
                <h2 class="text-2xl font-black italic mb-8 uppercase tracking-tighter text-white">Config. <span class="text-cyan-500">Opérateur</span></h2>
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-500 uppercase">Nom de l'Opérateur</label>
                        <input type="text" id="trader-name" oninput="forceAlpha(this)" class="input-pro w-full text-lg uppercase" placeholder="NOM">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-500 uppercase">Capital d'Amorçage ($)</label>
                        <input type="text" id="trader-capital" oninput="forceNum(this)" class="input-pro w-full text-lg mono" placeholder="1000.00">
                    </div>
                    <button onclick="saveProfile()" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase text-[10px] tracking-widest transition-all">
                        Initialiser le Profil
                    </button>
                </div>
            </div>
        </section>

        <!-- SECTION SÉCURITÉ -->
        <section id="legal-section" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bento-card p-10 border-t-4 border-cyan-500">
                    <h3 class="text-xl font-black text-cyan-400 mb-6 uppercase italic">Souveraineté Numérique</h3>
                    <div class="space-y-4 text-[11px] text-slate-400 font-bold leading-relaxed">
                        <p>Protocole "Local-Vault" activé. Vos données financières ne sont jamais transmises à des serveurs tiers. Tout est chiffré au sein de votre terminal local.</p>
                        <ul class="space-y-2 text-[9px] text-indigo-400 uppercase tracking-widest">
                            <li><i class="fas fa-check-circle mr-2"></i> Chiffrement AES-LocalStorage</li>
                            <li><i class="fas fa-check-circle mr-2"></i> Zéro Transmission Cloud</li>
                        </ul>
                    </div>
                </div>
                <div class="bento-card p-10 border-t-4 border-rose-600">
                    <h3 class="text-xl font-black text-rose-500 mb-6 uppercase italic">Avertissement Légal</h3>
                    <div class="space-y-4 text-[11px] text-slate-400 font-bold leading-relaxed">
                        <p>Le trading comporte des risques financiers majeurs. KAK_SYSTEM est un logiciel d'aide à la décision technique. L'opérateur reste seul maître de son capital.</p>
                        <p class="pt-4 border-t border-white/5 text-center text-[8px] text-slate-600">2026 - KAK_SYSTEM TOGO - LOMÉ</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL CORPORATIF EXHAUSTIF KAK_SYSTEM -->
    <div id="infoModal" class="modal-kak" onclick="if(event.target === this) toggleModal('infoModal')">
        <div class="bento-card max-w-3xl w-full p-10 relative border-t-4 border-cyan-500 my-10">
            <button onclick="toggleModal('infoModal')" class="absolute top-6 right-6 text-white hover:text-cyan-500"><i class="fas fa-times fa-xl"></i></button>
            
            <div class="text-center mb-8">
                <h2 class="text-4xl font-black text-white italic uppercase tracking-tighter">KAK <span class="text-cyan-500">SYSTEM</span></h2>
                <p class="text-slate-400 font-bold text-[8px] mt-2 uppercase tracking-[0.5em]">L'excellence au cœur du numérique</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-[10px] font-black leading-relaxed">
                <div class="p-4 bg-white/5 rounded-xl border border-white/5 col-span-1 md:col-span-2">
                    <h4 class="text-cyan-500 mb-2 uppercase text-[9px]"><i class="fas fa-eye mr-2"></i> Vision Stratégique</h4>
                    <p class="text-slate-400">Fondée en 2020 au Togo, KAK_SYSTEM est devenue l'acteur de référence en Afrique de l'Ouest pour la protection des infrastructures critiques. Nous assurons la résilience numérique des institutions financières et gouvernementales.</p>
                </div>

                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                    <h4 class="text-cyan-500 mb-2 uppercase text-[9px]"><i class="fas fa-user-shield mr-2"></i> Cybersécurité Offensive</h4>
                    <ul class="text-slate-500 space-y-1">
                        <li>• Tests d'Intrusion (Pentesting) Web & Réseaux</li>
                        <li>• SOC (Security Operations Center) 24/7</li>
                        <li>• Audit de Code Source & Analyse de Menaces</li>
                    </ul>
                </div>

                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                    <h4 class="text-cyan-500 mb-2 uppercase text-[9px]"><i class="fas fa-microchip mr-2"></i> Infrastructures IT</h4>
                    <ul class="text-slate-500 space-y-1">
                        <li>• Cloud Privé & Stockage Sécurisé (NAS/SAN)</li>
                        <li>• Virtualisation Serveurs Haute Disponibilité</li>
                        <li>• Déploiement Fibre Optique & VPN MPLS</li>
                    </ul>
                </div>

                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                    <h4 class="text-cyan-500 mb-2 uppercase text-[9px]"><i class="fas fa-chart-line mr-2"></i> FinTech & Trading</h4>
                    <ul class="text-slate-500 space-y-1">
                        <li>• Stations de Trading Ultra-Performantes</li>
                        <li>• Optimisation Réseau Basse Latence</li>
                        <li>• Monitoring de Marché Propriétaire</li>
                    </ul>
                </div>

                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                    <h4 class="text-cyan-500 mb-2 uppercase text-[9px]"><i class="fas fa-tools mr-2"></i> Hardware & Support</h4>
                    <ul class="text-slate-500 space-y-1">
                        <li>• Maintenance Préventive Industrielle</li>
                        <li>• Vente de Matériel Certifié (Dell, Cisco)</li>
                        <li>• Formation en Sécurité Informatique</li>
                    </ul>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-white/10">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-slate-500 text-[7px] uppercase">Siège Social</p>
                        <p class="text-white text-[9px] font-black uppercase">Lomé, Agbalépédogan, Togo</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-[7px] uppercase">E-mail Officiel</p>
                        <p class="text-white text-[9px] font-black uppercase">contact@kaksystem.tg</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-[7px] uppercase">Ligne Directe</p>
                        <p class="text-emerald-500 text-[9px] font-black uppercase">+228 91 75 07 48</p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <a href="https://wa.me/22891750748" target="_blank" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-black uppercase text-[10px] transition">
                        <i class="fab fa-whatsapp"></i> Rejoindre un Expert
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NOTES -->
    <div id="reasonModal" class="modal-kak" onclick="if(event.target === this) toggleModal('reasonModal')">
        <div class="bento-card max-w-lg w-full p-10 border-t-4 border-cyan-500 m-4">
            <h4 class="text-cyan-500 font-black uppercase text-[9px] mb-6 italic">Log Analyse Position</h4>
            <p id="fullReasonText" class="text-slate-300 italic text-[12px] leading-relaxed font-bold"></p>
            <button onclick="toggleModal('reasonModal')" class="mt-8 bg-white/5 w-full py-3 rounded-xl text-[9px] font-black uppercase">Fermer</button>
        </div>
    </div>

    <script>
        function forceAlpha(el) { el.value = el.value.replace(/[^a-zA-Z\s]/g, ''); }
        function forceNum(el) { el.value = el.value.replace(/[^0-9.]/g, ''); calculateLotTool(); }
        function forcePnL(el) { el.value = el.value.replace(/[^0-9.-]/g, ''); }

        let trades = JSON.parse(localStorage.getItem('kak_v52_db')) || [];
        let profile = JSON.parse(localStorage.getItem('kak_v52_profile')) || { name: 'OP_SYS', capital: 0 };

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toTimeString().split(' ')[0] + " UTC";
        }

        window.onload = () => {
            document.getElementById('trader-name').value = profile.name;
            document.getElementById('trader-capital').value = profile.capital;
            setInterval(updateClock, 1000);
            updateClock();
            updateUI();
        };

        function toggleModal(id) { document.getElementById(id).classList.toggle('active'); }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`${t}-section`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).classList.add('active');
        }

        function saveProfile() {
            profile.name = document.getElementById('trader-name').value.trim().toUpperCase() || 'OP';
            profile.capital = parseFloat(document.getElementById('trader-capital').value) || 0;
            localStorage.setItem('kak_v52_profile', JSON.stringify(profile));
            updateUI();
            switchTab('terminal');
        }

        function updateUI() {
            document.getElementById('side-profile-name').innerText = profile.name;
            document.getElementById('side-profile-capital').innerText = profile.capital.toLocaleString() + " $";
            
            const netTotal = trades.reduce((acc, t) => acc + (t.pnl - t.comm), 0);
            const balance = profile.capital + netTotal;
            document.getElementById('display-capital').innerText = `$${balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            
            // Stats
            const wins = trades.filter(t => t.pnl > 0);
            const losses = trades.filter(t => t.pnl <= 0);
            const wr = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
            document.getElementById('stat-wr').innerText = `${Math.round(wr)}%`;
            document.getElementById('winrate-bar').style.width = `${wr}%`;

            const grossProfit = wins.reduce((acc, t) => acc + t.pnl, 0);
            const grossLoss = Math.abs(losses.reduce((acc, t) => acc + t.pnl, 0));
            const pf = grossLoss === 0 ? grossProfit.toFixed(2) : (grossProfit / grossLoss).toFixed(2);
            document.getElementById('stat-pf').innerText = pf;

            document.getElementById('stat-avg-win').innerText = wins.length > 0 ? (grossProfit / wins.length).toFixed(1) + "$" : "0$";
            document.getElementById('stat-avg-loss').innerText = losses.length > 0 ? (grossLoss / losses.length).toFixed(1) + "$" : "0$";

            const avgRR = trades.length > 0 ? (trades.reduce((acc, t) => acc + parseFloat(t.rr), 0) / trades.length).toFixed(1) : "0.0";
            document.getElementById('stat-avg-rr').innerText = `1:${avgRR}`;

            const last = trades[trades.length - 1];
            const prev = trades[trades.length - 2];
            if(last) {
                const ln = last.pnl - last.comm;
                document.getElementById('comp-last').innerText = `${ln >= 0 ? '+' : ''}${ln.toFixed(1)}$`;
                document.getElementById('comp-last').className = `text-lg font-black ${ln >= 0 ? 'text-emerald-400' : 'text-rose-500'}`;
            }
            if(prev) {
                const ln = last.pnl - last.comm;
                const pn = prev.pnl - prev.comm;
                document.getElementById('comp-prev').innerText = `${pn.toFixed(1)}$`;
                const icon = document.getElementById('comp-trend-icon');
                const percent = document.getElementById('comp-percent');
                const diff = ln - pn;
                const change = pn !== 0 ? ((diff / Math.abs(pn)) * 100).toFixed(0) : "100";
                icon.innerHTML = ln > pn ? '<i class="fas fa-arrow-up text-emerald-400"></i>' : '<i class="fas fa-arrow-down text-rose-500"></i>';
                percent.innerText = `${change}%`;
            }
            renderJournal();
        }

        document.getElementById('tradeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const sl = parseFloat(document.getElementById('sl').value) || 1;
            const tp = parseFloat(document.getElementById('tp').value) || 0;
            const t = {
                id: Date.now(),
                time: new Date().toLocaleDateString('fr-FR', {day:'2-digit', month:'short'}),
                asset: document.getElementById('asset').value.toUpperCase(),
                side: document.getElementById('side').value,
                session: document.getElementById('session').value,
                strategy: document.getElementById('strategy').value.toUpperCase() || 'PRICE ACTION',
                rr: (tp / sl).toFixed(2),
                comm: parseFloat(document.getElementById('comm').value) || 0,
                pnl: parseFloat(document.getElementById('pnl').value),
                reason: document.getElementById('reason').value || "N/A"
            };
            trades.push(t);
            localStorage.setItem('kak_v52_db', JSON.stringify(trades));
            updateUI();
            e.target.reset();
        });

        function renderJournal() {
            const list = document.getElementById('trade-list');
            if(trades.length === 0) {
                list.innerHTML = `<tr><td colspan="7" class="p-10 text-center text-slate-700 font-black uppercase text-[9px]">Aucune donnée</td></tr>`;
                return;
            }
            list.innerHTML = trades.slice().reverse().map(t => `
                <tr class="hover:bg-white/5 transition-all text-[9px] font-black">
                    <td class="p-5 text-slate-500 uppercase">${t.time}</td>
                    <td class="p-5 text-white uppercase">${t.asset}</td>
                    <td class="p-5 text-cyan-400 uppercase">${t.side}</td>
                    <td class="p-5 text-slate-400">${t.session}</td>
                    <td class="p-5 text-indigo-400">1:${t.rr}</td>
                    <td class="p-5 text-center ${(t.pnl-t.comm) >= 0 ? 'text-emerald-400' : 'text-rose-500'}">
                        ${(t.pnl-t.comm).toFixed(2)}$
                    </td>
                    <td class="p-5 text-right flex gap-3 justify-end items-center">
                        <button onclick="viewFullReason(${t.id})" class="text-cyan-500"><i class="fas fa-file-alt"></i></button>
                        <button onclick="deleteTrade(${t.id})" class="text-slate-800 hover:text-rose-500"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function calculateLotTool() {
            const r = parseFloat(document.getElementById('calc-risk').value);
            const s = parseFloat(document.getElementById('calc-sl-tool').value);
            if(r && s) document.getElementById('calc-result').innerText = (r / (s * 10)).toFixed(2);
            else document.getElementById('calc-result').innerText = "0.00";
        }

        function viewFullReason(id) {
            const t = trades.find(tr => tr.id === id);
            document.getElementById('fullReasonText').innerText = t.reason;
            toggleModal('reasonModal');
        }

        function deleteTrade(id) {
            if(confirm("Supprimer l'archive ?")) {
                trades = trades.filter(t => t.id !== id);
                localStorage.setItem('kak_v52_db', JSON.stringify(trades));
                updateUI();
            }
        }

        function resetSystem() {
            if(confirm("EFFACER TOUT ?")) { localStorage.clear(); location.reload(); }
        }

        function exportCSV() {
            let csv = "Date,Asset,Type,Session,RR,Net_PnL\n";
            trades.forEach(t => csv += `${t.time},${t.asset},${t.side},${t.session},${t.rr},${(t.pnl-t.comm).toFixed(2)}\n`);
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `KAK_LEDGER.csv`;
            a.click();
        }
    </script>
</body>
</html>